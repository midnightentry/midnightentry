<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#050814" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Notes</title>

  <!-- Share preview (neutral) -->
  <meta property="og:title" content="Notes" />
  <meta property="og:description" content="Personal workspace." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://midnightentry.github.io/midnightentry/" />
  <meta property="og:image" content="https://midnightentry.github.io/midnightentry/og.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Notes" />
  <meta name="twitter:description" content="Personal workspace." />
  <meta name="twitter:image" content="https://midnightentry.github.io/midnightentry/og.png" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{ color-scheme: dark; }

    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 20% 20%, rgba(90,160,255,.35), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(46,93,255,.25), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(0,255,240,.12), transparent 60%),
        linear-gradient(180deg, #071022, #050814);
      color: rgba(255,255,255,.95);
    }

    .card{
      width:min(560px, 92vw);
      padding:30px 24px;
      border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 25px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
    }

    h1{ margin:0 0 10px; font-size:28px; letter-spacing:.2px; }
    p{ margin:0 0 18px; opacity:.9; line-height:1.45; }

    .btns{ display:grid; gap:12px; margin-top:14px; }

    button, a.btn{
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:white;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      text-align:center;
      transition:.18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    button:hover, a.btn:hover{ background:rgba(255,255,255,.14); }
    button:active, a.btn:active{ transform: translateY(1px); }

    .note{
      margin-top:18px;
      padding:14px;
      border-radius:14px;
      background:rgba(0,0,0,.25);
      font-size:13px;
      border:1px solid rgba(255,255,255,.10);
      line-height:1.45;
    }
    .small{ margin-top:12px; font-size:12px; opacity:.78; line-height:1.45; }

    hr{
      border:0;
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 18px 0;
    }

    /* PIN overlay */
    #lock{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background: rgba(5,8,20,.95);
      z-index:9999;
      padding: 22px;
    }
    #lockCard{
      width:min(420px, 92vw);
      background:rgba(255,255,255,.06);
      border-radius:18px;
      padding:22px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 24px 60px rgba(0,0,0,.45);
    }
    #pin{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:white;
      text-align:center;
      font-size:18px;
      letter-spacing:6px;
      outline:none;
    }
    #unlock{
      margin-top:12px;
      width:100%;
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:white;
      font-weight:900;
      cursor:pointer;
    }
    #lockMsg{ margin-top:10px; font-size:13px; opacity:.85; }

    /* Fade overlay */
    #fade{
      position:fixed; inset:0;
      background:#050814;
      opacity:0;
      transition:opacity .25s ease;
      z-index:9998;
      pointer-events:none;
    }
    #fade.on{ opacity:1; }
  </style>

  <link rel="preconnect" href="https://app.element.io">
  <link rel="preconnect" href="https://meet.jit.si">
</head>

<body>
  <div id="fade"></div>

  <!-- PIN LOCK -->
  <div id="lock">
    <div id="lockCard">
      <div style="font-weight:900; font-size:20px; margin-bottom:8px;">ðŸ”’ Access PIN</div>
      <div style="opacity:.85; font-size:14px; margin-bottom:12px; line-height:1.35;">
        Private entry.
      </div>
      <input id="pin" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" autocomplete="one-time-code" />
      <button id="unlock" type="button">Unlock</button>
      <div id="lockMsg"></div>
    </div>
  </div>

  <main class="card">
    <h1>Notes</h1>
    <p>Personal workspace.</p>

    <div class="btns">
      <a class="btn" id="chatBtn" href="#" rel="noopener">Open</a>

      <a class="btn" id="videoCall" href="#" target="_blank" rel="noopener">Video Call</a>
      <a class="btn" id="audioCall" href="#" target="_blank" rel="noopener">Audio Call</a>

      <button id="copyCall" type="button">Copy Call Link</button>
      <button id="newCall" type="button">New Call Link</button>

      <hr>

      <button id="panicLock" type="button">Lock</button>
    </div>

    <div class="note">
      Install like an app:
      <br>â€¢ iPhone: Safari â†’ Share â†’ Add to Home Screen
      <br>â€¢ Android: Chrome â†’ â‹® â†’ Add to Home screen
    </div>

    <div class="small">
      Tip: If a share preview still shows an old title, share with <b>?v=2</b> at the end of the link once.
    </div>
  </main>

  <script>
    // Register PWA service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }

    /* ===== CONFIG ===== */

    // PIN = 1127 (SHA-256)
    const PIN_HASH = "7377a71607a8dabc029ab10e7a6a895b92e87762538b10ce8b10c4c9ddc74448";
    const FADE_MS = 220;

    // Element private room
    const ROOM_ID = "!QCDoDUrbQEiLoiTDVl:matrix.org";
    const ELEMENT_ROOM_URL = "https://app.element.io/#/room/" + ROOM_ID;

    // Auto-lock after inactivity
    const AUTO_LOCK_AFTER_MS = 2 * 60 * 1000; // 2 minutes

    /* ===== CACHED DOM REFERENCES ===== */
    const fadeEl = document.getElementById("fade");
    const lockEl = document.getElementById("lock");
    const lockMsgEl = document.getElementById("lockMsg");
    const pinEl = document.getElementById("pin");
    const unlockBtn = document.getElementById("unlock");
    const chatBtn = document.getElementById("chatBtn");
    const videoCallEl = document.getElementById("videoCall");
    const audioCallEl = document.getElementById("audioCall");

    async function sha256Hex(text){
      const data = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(buf), b => b.toString(16).padStart(2, "0")).join("");
    }

    function fadeThen(action){
      fadeEl.classList.add("on");
      setTimeout(action, FADE_MS);
    }

    // Auto-lock after inactivity
    let idleTimer = null;
    let debounceTimer = null;
    let listenersActive = false;
    const IDLE_EVENTS = ["mousemove","keydown","touchstart","click","scroll"];

    function resetIdleTimer(){
      if (sessionStorage.getItem("unlocked") !== "1") return;
      clearTimeout(debounceTimer);
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => lockNow("Locked (inactive)."), AUTO_LOCK_AFTER_MS);
    }

    function debouncedResetIdleTimer(){
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(resetIdleTimer, 100);
    }

    function addIdleListeners(){
      if (listenersActive) return;
      IDLE_EVENTS.forEach(evt => {
        window.addEventListener(evt, debouncedResetIdleTimer, { passive:true });
      });
      listenersActive = true;
    }

    function removeIdleListeners(){
      if (!listenersActive) return;
      IDLE_EVENTS.forEach(evt => {
        window.removeEventListener(evt, debouncedResetIdleTimer, { passive:true });
      });
      listenersActive = false;
    }

    function lockNow(message=""){
      lockEl.style.display = "grid";
      lockMsgEl.textContent = message;
      sessionStorage.removeItem("unlocked");
      removeIdleListeners();
      clearTimeout(idleTimer);
      clearTimeout(debounceTimer);
    }

    function unlockNow(){
      lockEl.style.display = "none";
      lockMsgEl.textContent = "";
      sessionStorage.setItem("unlocked","1");
      addIdleListeners();
      resetIdleTimer();
    }

    unlockBtn.addEventListener("click", async () => {
      const pin = (pinEl.value || "").trim();
      const h = await sha256Hex(pin);
      if (h === PIN_HASH) {
        fadeThen(() => {
          unlockNow();
          fadeEl.classList.remove("on");
        });
      } else {
        lockMsgEl.textContent = "Wrong PIN";
      }
    });

    pinEl.addEventListener("keydown",(e)=>{
      if (e.key === "Enter") unlockBtn.click();
    });

    chatBtn.addEventListener("click", (e) => {
      e.preventDefault();
      if (sessionStorage.getItem("unlocked") !== "1") {
        lockNow("Enter PIN first.");
        return;
      }
      fadeThen(() => window.location.href = ELEMENT_ROOM_URL);
    });

    // Jitsi rotating call link
    function generateRoom(){
      const bytes = new Uint8Array(8);
      crypto.getRandomValues(bytes);
      return Array.from(bytes, b => b.toString(16).padStart(2,"0")).join("");
    }

    function newCall(){
      const room = "notes-" + generateRoom();
      const base = "https://meet.jit.si/" + room;
      videoCallEl.href = base;
      audioCallEl.href = base + "#config.startWithVideoMuted=true";
      window.currentCall = base;
    }
    newCall();

    document.getElementById("copyCall").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(window.currentCall);
        alert("Copied");
      } catch {
        alert("Copy failed. Link:\n\n" + window.currentCall);
      }
    });

    document.getElementById("newCall").addEventListener("click", () => {
      newCall();
      alert("New link created");
    });

    document.getElementById("panicLock").addEventListener("click", () => {
      lockNow("Locked.");
    });

    // On load
    if (sessionStorage.getItem("unlocked") === "1") unlockNow();
    else lockNow();
  </script>
</body>
</html>
